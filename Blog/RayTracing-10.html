<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Optimizing a Raytracer</title>
    <link rel="icon" type="image/x-icon" href="../Images/RayTracing/computeShaderRenderCornellSmol.webp">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Loris Moreau">
    <meta name="description" content="Raytracing Blog">
    <meta name="keywords" content="Showcase, Loris, Moreau, Loris Moreau, Programmer, coding adventure, Blog, Post, Raytracing, C++, CPP, Raytracing in one weekend, Optimization, optimized, optimizing, Compute, shaders, Compute Shader, multi threading, Hyper threading, SIMD, optimizing a raytracer, raytracer optimization, efficient raytracing, efficient raytracer, optimized raytracing, improving raytracer performance, performance">

    <!-- Styles -->
    <link rel="stylesheet" href="../Styles/style.css">
    <link rel="stylesheet" href="../Styles/Code-Quote.css">

    <!-- Carousel script (deferred) -->
    <script src="../Scripts/Carousel.js" defer></script>

    <style>
        /* Small local style for quote */
        .quote {
            background: var(--code-title-bg-color);
            padding: 0.1em 0.6em;
            margin: 0 0.2em;
            border-radius: 0.4em;
            font-size: 0.95rem;
            color: var(--text-color-bright);
        }
    </style>
</head>

<body>
<!-- Main of the post -->
<main id="BlogPost" class="post">

    <!-- Top showcase: navbar + carousel + intro -->
    <header>
        <!-- ========== Section 1 Navbar ========== -->
        <nav style="margin: 0 auto 2em auto;">
            <ul>
                <li><a href="../Blog.html">Back</a></li>
                <li><a href="../index.html" target="_blank">Main</a></li>
                <li><a href="../Blog.html" target="_blank">Blog</a></li>
                <li><a href="../Resources.html" target="_blank">Resources</a></li>
            </ul>
        </nav>

        <!-- Carousel + intro column -->
        <div class="flex-container">
            <div class="showcase-carousel" role="region" aria-label="Showcase carousel">
                <button class="carousel-button prev" aria-label="Previous slide">&larr;</button>
                <div class="carousel-viewport">
                    <div class="carousel-track">
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/RayTracing/Final%20Render%20high-Res%20(B2).webp" alt="Final Render of Book 2">
                        </div>
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/RayTracing/computeShaderRenderCornell.webp" alt="Compute Shader Cornell">
                        </div>
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/RayTracing/computeShaderRenderB2.webp" alt="Compute Shader B2">
                        </div>
                    </div>
                </div>
                <button class="carousel-button next" aria-label="Next slide">&rarr;</button>
                <div class="carousel-dots" aria-hidden="false"></div>
            </div>

            <!-- Intro / author column -->
            <div class="text-container">
                <h1>Optimizing a Raytracer</h1>
                <p>I'm Loris Moreau. here is my research project focused on <strong>Optimization</strong> — using SIMD, Multithreading and Compute Shaders.</p>
                
                <p>
                    <a target="_blank" href="https://github.com/Loris-Moreau/RayTracing/tree/Compute-Shader" class="cta-button">GitHub Repository</a>
                    <a target="_blank" href="R-10_Bibliography.html" class="cta-button secondary" style="margin-left:0.5rem">Project Bibliography</a>
                </p>
            </div>
        </div>
    </header>

    <!-- Section 1: Overview / State of the art -->
    <section>
        <div>
            <h2 class="underline" style="text-decoration-color: dodgerblue">Optimization, Multithreading, SIMD & Compute Shaders</h2>

            <p>After finishing the <a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html" target="_blank">1st book</a> I was annoyed at render times. The goal is to parallelize the existing raytracing code to dramatically cut render times.</p>

            <p><a href="#SIMD">SIMD</a> - <a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data" target="_blank">explanation</a></p>
            <p><a href="#MultiThreading">Multithreading</a> - <a href="https://en.wikipedia.org/wiki/Multithreading_(computer_architecture)" target="_blank">explanation</a></p>
            <p><a href="#Compute">Compute Shaders</a> - <a href="https://www.khronos.org/opengl/wiki/Compute_Shader" target="_blank">explanation</a></p>

            <p>Each approach should shorten render times and allow more samples &amp; bounces.</p>

            <h2 class="underline" style="text-decoration-color: cadetblue">State of the art</h2>
            <p>We build on Peter Shirley’s <a href="https://raytracing.github.io" target="_blank">Ray Tracing in One Weekend</a> and community ports such as <a href="https://github.com/utilForever/ray-tracing-in-one-weekend-cpp" target="_blank">utilForever</a> and CUDA adaptations.</p>
        </div>

        <p></p>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/Final%20Render%20high-Res%20(B2).webp" alt="Final Render of Book 2" />
            <figcaption><a href="https://github.com/Loris-Moreau/RayTracing/blob/main/Images/Final%20Render%20high-Res%20(B2).webp" target="_blank">img. Source</a></figcaption>
        </figure>
    </section>

    <!-- Section 2: SIMD & Amdahl -->
    <section>
        <h2 id="SIMD" class="underline" style="text-decoration-color: royalblue">SIMD</h2>

        <p>SIMD (Single Instruction, Multiple Data) is data-level parallelism. It lets hardware vector units operate on many elements at once.</p>

        <p></p>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/SIMD-operation.webp" alt="SISD vs SIMD Operations" />
            <figcaption><a href="https://blog.wasmer.io/webassembly-and-simd-13badb9bf1a8" target="_blank">img. Source</a></figcaption>
        </figure>

        <h3>Things to remember</h3>
        <p>- If you use correct memory layouts, many SIMD problems solve themselves.</p>
        <p>- Parallel performance depends on how parallel the program is.</p>
        <p>- Compile with <span class="quote">-march=native</span> to get CPU-optimized code.</p>

        <!-- Code snippet -->
        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>SIMD.h</p></div>
                <div class="Sconsole">
<pre><code>// Wide vector3 struct
struct LaneVector3
{
    LaneF32 x;
    LaneF32 y;
    LaneF32 z;

    LaneVector3();
    LaneVector3(LaneF32 x, LaneF32 y, LaneF32 z);
    LaneVector3(float arr[3][LANE_WIDTH]);
    LaneVector3(Vector3 vector);

    LaneF32& operator[](int index);
};</code></pre>
                </div>
            </div>
        </div>

        <h2 class="underline" style="text-decoration-color: cadetblue">Amdahl's Law</h2>
        <p>Amdahl’s Law limits overall speedup when part of a program must remain serial. In our case, much time is spent in the Intersection function.</p>

        <p></p>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/AmdahlsLaw.webp" alt="Amdahl's Law" />
            <figcaption><a href="https://en.wikipedia.org/wiki/Amdahl_law" target="_blank">img. Source</a></figcaption>
        </figure>

        <p>With SIMD we managed to cut render time in two for some cases.</p>

        <h3>Final recorded times</h3>
        <p><b class="quote">case 10: FinalSceneB2(600, 200, 100, 20, 250) :</b></p>
        <p><b class="quote">- Non-Optimized : 5 Hrs</b></p>
        <p><b class="quote">- SIMD Optimized : 2 Hrs 18 Min</b></p>
    </section>

    <!-- Section 3: Multithreading -->
    <section>
        <h2 id="MultiThreading" class="underline" style="text-decoration-color: royalblue">Multithreading</h2>
        <p>Multithreading splits work across CPU cores. Raytracing is "embarrassingly parallel" — each pixel can be computed independently.</p>

        <p></p>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/40-years-processor-trend.webp" alt="40 Years Processor Trend" />
            <figcaption><a href="https://www.karlrupp.net/2015/06/40-years-of-microprocessor-trend-data" target="_blank">img. Source</a></figcaption>
        </figure>

        <h3>Work queue example</h3>
        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Work Queue</p></div>
                <div class="Sconsole">
<pre><code>struct WorkOrder 
{
    Image* image;
    World* world;
    uint32_t startRowIndex;
    uint32_t endRowIndex;
    uint32_t sampleSize;
    uint32_t* randomState;
};
/* ... */</code></pre>
                </div>
            </div>
        </div>

        <p>Multithreading gave ~2x speedup in practice for this project (with diminishing returns past 3–4 threads).</p>
        <p><b class="quote">- Multithreading Optimized : 2 Hrs 9 Min</b></p>
    </section>

    <!-- Section 4: Compute Shaders -->
    <section>
        <h2 id="Compute" class="underline" style="text-decoration-color: royalblue">Compute Shaders</h2>

        <p>Compute shaders let GPUs run massive numbers of threads — converting raytracing to compute shaders provides huge speedups.</p>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>fragment.glsl</p></div>
                <div class="Sconsole">
<pre><code>#version 450 core
in vec2 texCoord;
uniform sampler2D image;
out vec4 finalColor;

/* ... shader code ... */</code></pre>
                </div>
            </div>
        </div>

        <p></p>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/computeShaderRenderCornell.webp" alt="Compute Shader Cornell" />
            <figcaption>
                <span class="underline" style="text-decoration-color: limegreen; text-decoration-thickness: 2px">Render time :</span>
                regular = 30mins; compute shaders = 1min — <a href="https://github.com/Loris-Moreau/RayTracing/blob/Compute-Shader/Images/computeShaderRenderCornell.webp" target="_blank">img. Source</a>
            </figcaption>
        </figure>

        <p></p>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/computeShaderRenderB2.webp" alt="Compute Shader B2" />
            <figcaption>
                <span class="underline" style="text-decoration-color: limegreen; text-decoration-thickness: 2px">Render time :</span>
                regular = 5hrs; compute shaders = 30sec — <a href="https://github.com/Loris-Moreau/RayTracing/blob/Compute-Shader/Images/computeShaderRenderB2.webp" target="_blank">img. Source</a>
            </figcaption>
        </figure>

        <p><b class="quote">- Compute Shader Optimized : 30 sec</b></p>
    </section>

    <!-- Conclusion -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Conclusion</h2>
        <p>SIMD &amp; Multithreading are valuable but limited by Amdahl's Law. Compute shaders give large speedups — put what you can on the GPU and the rest in SIMD lanes where appropriate.</p>
        <p>Final implementation: <a href="https://github.com/Loris-Moreau/RayTracing/tree/Compute-Shader" target="_blank">GitHub: Compute-Shader branch</a></p>
    </section>

    <footer>
        <p style="color: var(--text-color-bright);">07-05-2025</p>
    </footer>

</main>

<!-- Navigation buttons -->
<div style="text-align:center; margin-top:1rem">
    <a href="R-9.html" class="cta-button">Previous</a>
    <a href="../Blog.html" class="cta-button secondary" style="margin:0 0.75rem">Entries</a>
    <a href="VFX-1.html" class="cta-button">Next</a>
</div>

</body>
</html>
