<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RayTracing 5</title>
    <link rel="icon" type="image/x-icon" href="../Images/Suprise.webp">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Loris Moreau">
    <meta name="description" content="Raytracing Blog">
    <meta name="keywords" content="Showcase, Loris, Moreau, Loris Moreau, Programmer, coding adventure, Blog, Post, Raytracing, C++, CPP, Raytracing in one weekend, camera, thin lenses">

    <!-- Styles -->
    <link rel="stylesheet" href="../Styles/style.css">
    <link rel="stylesheet" href="../Styles/Code-Quote.css">

    <!-- Carousel script (deferred) -->
    <script src="../Scripts/Carousel.js" defer></script>

</head>

<body>
<!-- Main of the post -->
<main id="BlogPost" class="post">
    <!-- Top showcase: carousel + short intro in a flex row -->
    <header>
        <!-- ========== Section 1 Navbar ========== -->
        <nav style="margin: 0 auto 2em auto;">
            <ul>
                <li><a href="../Blog.html">Back</a></li>
                <li><a href="../index.html" target="_blank">Main</a></li>
                <li><a href="../Blog.html" target="_blank">Blog</a></li>
                <li><a href="../Resources.html" target="_blank">Resources</a></li>
            </ul>
        </nav>

        <div class="flex-container">
            <div class="showcase-carousel" role="region" aria-label="Showcase carousel">
                <button class="carousel-button prev" aria-label="Previous slide">&larr;</button>
                <div class="carousel-viewport">
                    <div class="carousel-track">
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/RayTracing/SimpleRaytracing.webp" alt="Simple Raytracing Render">
                        </div>
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/RayTracing/antialiasing.webp" alt="Antialiasing diagram">
                        </div>
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/Suprise.webp" alt="Suprise">
                        </div>
                    </div>
                </div>
                <button class="carousel-button next" aria-label="Next slide">&rarr;</button>
                <div class="carousel-dots" aria-hidden="false"></div>
            </div>

            <!-- Intro / author column -->
            <div class="text-container">
                <h1>Raytracing in one weekend in C++</h1>
                <p>Part 5 â€” Camera management & anti-aliasing</p>
                <p>Here we refactor camera logic and add sampling for smoother renders.</p>
                <p><a target="_blank" href="https://github.com/Loris-Moreau/RayTracing" class="cta-button">GitHub Repository</a></p>
            </div>
        </div>
    </header>

    <!-- Section: Camera -->
    <section>
        <div>
            <h2 class="underline" style="text-decoration-color: dodgerblue">Camera management</h2>
            <p>Adjusting our point of view and encapsulating render logic in a Camera class helps keep main tidy.</p>

            <!-- Camera.h -->
            <div class="snippet">
                <div class="Swindow">
                    <div class="Swindow-title"><p>Camera.h</p></div>
                    <div class="Sconsole">
<pre><code>#pragma once

#include "Color.h"
#include "Hittable.h"

class Camera
{
public:
   Camera() = default;
   Camera(double imageWidth, double ratio): aspectRatio(ratio), width(imageWidth){}
   void Render(const Hittable& rWorld);

private:
   int height;
   double aspectRatio, width;
   Position center, originPixelLocation;
   Vector3 pixelDeltaX, pixelDeltaY;
  
   void Initialize();
   Color RayColor(const Ray& rRay, const Hittable& rWorld) const;
};</code></pre>
                    </div>
                </div>
            </div>

            <!-- Camera.cpp -->
            <div class="snippet">
                <div class="Swindow">
                    <div class="Swindow-title"><p>Camera.cpp</p></div>
                    <div class="Sconsole">
<pre><code>void Camera::Render(const Hittable& rWorld)
{
   Initialize();
   cout &lt&lt "P3\n" &lt&lt width &lt&lt ' ' &lt&lt height &lt&lt "\n255\n";
   for(int y = 0; y &lt height; y ++)
   {
       clog &lt&lt "Progress : " &lt&lt (y*100/height) &lt&lt " %\n" &lt&lt flush;
       for (int x = 0; x &lt width; x ++)
       {
           Position pixelCenter = originPixelLocation + (x * pixelDeltaX) + (y * pixelDeltaY);
           Vector3 direction = pixelCenter - center;
           Ray ray(center, direction);
           Color pixel = RayColor(ray, rWorld);
           WriteColor(cout, pixel);
       }
   }
   clog &lt&lt "Done! You can open your file now :) \n";
}

void Camera::Initialize()
{
   height = static_cast&ltint>(width / aspectRatio);
   if(height &lt 1) height = 1;
  
   center = Position(0, 0, 0);
   double focalLength = 1;
   double viewportHeight = 2;
   double viewportWidth = viewportHeight * (static_cast&ltdouble>(width)/height);

   Vector3 viewportX = Vector3(viewportWidth, 0, 0);
   Vector3 viewportY = Vector3(0, -viewportHeight, 0); // invert Y
  
   //Delta vector between pixels
   pixelDeltaX = viewportX / width;
   pixelDeltaY = viewportY / height;

   //Position of the top left pixel
   Vector3 viewportOrigin = center - Vector3(0, 0, focalLength) - viewportX / 2 - viewportY / 2;

   originPixelLocation = viewportOrigin + 0.5 * (pixelDeltaX + pixelDeltaY);

}

Color Camera::RayColor(const Ray& rRay, const Hittable& rWorld) const
{
   HitInfo hitInfo;
   if (rWorld.Hit(rRay, Interval(0, infinity), hitInfo)) {
       return 0.5 * (hitInfo.normal + Color(1,1,1));
   }
 
   Vector3 unitDirection = Unit(rRay.GetDirection());
   double blue = 0.5 * (unitDirection.y + 1.0);
   return (1.0 - blue) * Color(1.0, 1.0, 1.0) + blue * Color (0.5, 0.7, 1.0);
}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: main cleanup -->
    <section>
        <h2 class="underline" style="text-decoration-color: dodgerblue">Clean up main</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Raytracing.cpp</p></div>
                <div class="Sconsole">
<pre><code>#include "Camera.h"
#include "HittableCollection.h"
#include "Sphere.h"

using namespace std;

int main(int argc, char* argv[])
{
   // World
   HittableCollection world;
   world.Add(make_shared&ltSphere>(Position(0,0,-1), 0.5));
   world.Add(make_shared&ltSphere>(Position(0,-100.5,-1), 100));
  
   // Render
   Camera camera(400, 16.0/9.0);
   camera.Render(world);

   return 0;
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Anti-aliasing -->
    <section>
        <h2 class="underline" style="text-decoration-color: dodgerblue; padding-bottom: 5px">Anti-aliasing</h2>
        <h5><i>the smooth stuff</i></h5>

        <p>Sampling multiple rays per pixel and averaging results reduces aliasing. Randomized subpixel sampling yields a smoother image.</p>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/antialiasing.webp" alt="Anti Aliasing" style="width:40%;" />
        </figure>
    </section>

    <!-- Section: Random / utilities / Color write -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Random Number & Color write</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Utility.h</p></div>
                <div class="Sconsole">
<pre><code>#pragma once

#include &ltcmath>
#include &ltlimits>
#include &ltmemory>
#include "Ray.h"
#include &ltcstdlib>

...

inline double RandomDouble()
{
   return rand() / (RAND_MAX + 1.0);
}

inline double RandomDouble(double min, double max)
{
   return min + (max - min) * RandomDouble();
}</code></pre>
                </div>
            </div>
        </div>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Interval.h</p></div>
                <div class="Sconsole">
<pre><code>double Clamp(double x) const
{
   return x &lt min ? min : x &gt max ? max : x;
}</code></pre>
                </div>
            </div>
        </div>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Color.h</p></div>
                <div class="Sconsole">
<pre><code>#include "Interval.h"

inline void WriteColor(std::ostream &out, Color pixel, int sampleCount)
{
   double scale = 1.0 / sampleCount;
   double r = pixel.x * scale;
   double g = pixel.y * scale;
   double b = pixel.z * scale;
  
   // Write the translated [0,255] value of each color component.
   static const Interval intensity(0.000, 0.999);
   out &lt&lt static_cast&ltint>(255.999 * intensity.Clamp(r)) &lt&lt ' '
       &lt&lt static_cast&ltint>(255.999 * intensity.Clamp(g)) &lt&lt ' '
       &lt&lt static_cast&ltint>(255.999 * intensity.Clamp(b)) &lt&lt '\n';
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Camera sampling additions -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Camera: sampling & GetRay</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Camera.h</p></div>
                <div class="Sconsole">
<pre><code>class Camera
{
public:
   Camera() = default;
   Camera(double imageWidth, double ratio, int samplePerPixel = 10): 
   aspectRatio(ratio), width(imageWidth), sampleCount(samplePerPixel){}

   void Render(const Hittable& rWorld);

private:
   int height;
   double aspectRatio, width;
   int sampleCount;
   Position center, originPixelLocation;
   Vector3 pixelDeltaX, pixelDeltaY;
  
   void Initialize();
   Color RayColor(const Ray& rRay, const Hittable& rWorld) const;
   Ray GetRay(int x, int y) const;
   Vector3 PixelSampleSquared() const;
};</code></pre>
                </div>
            </div>
        </div>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Camera.cpp</p></div>
                <div class="Sconsole">
<pre><code>void Camera::Render(const Hittable& rWorld)
{
   Initialize();
   cout &lt&lt "P3\n" &lt&lt width &lt&lt ' ' &lt&lt height &lt&lt "\n255\n";
   for(int y = 0; y &lt height; y ++)
   {
       clog &lt&lt "Progress : " &lt&lt (y*100/height) &lt&lt " %\n" &lt&lt flush;
       for (int x = 0; x &lt width; x ++)
       {
           Color pixel(0,0,0);
           for(int sample = 0; sample &lt sampleCount; sample ++)
           {
               Ray ray = GetRay(x, y);
               pixel += RayColor(ray, rWorld);
           }
          
           WriteColor(cout, pixel, sampleCount);
       }
   }
   clog &lt&lt "Done! You can open your file now :)\n";
}

Ray Camera::GetRay(int x, int y) const
{
   // Get a randomly sampled camera ray for the pixel at location i, j.

   Vector3 pixelCenter = originPixelLocation + (x * pixelDeltaX) + (y * pixelDeltaY);
   Vector3 pixelSample = pixelCenter + PixelSampleSquared();

   Position rayOrigin = center;
   Vector3 rayDirection = pixelSample - rayOrigin;

   return Ray(rayOrigin, rayDirection);
}

Vector3 Camera::PixelSampleSquared() const
{
   // Returns a random point in the square around a pixel at the origin
   double pX = -0.5 + RandomDouble();
   double pY = -0.5 + RandomDouble();
   return (pX * pixelDeltaX) + (pY * pixelDeltaY);
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: sample count in main -->
    <section>
        <div>
            <h3>Add sampling count in main</h3>
            <div class="snippet">
                <div class="Swindow">
                    <div class="Swindow-title"><p>Raytracing.cpp</p></div>
                    <div class="Sconsole">
<pre><code>int main(int argc, char* argv[])
{
   // World
   HittableCollection world;
   world.Add(make_shared&ltSphere>(Position(0,0,-1), 0.5));
   world.Add(make_shared&ltSphere>(Position(0,-100.5,-1), 100));
   
   // Render
   Camera camera(400, 16.0/9.0, 100);
   camera.Render(world);
   return 0;
}</code></pre>
                    </div>
                </div>
            </div>

            <p>Now render and admire the smoother image produced by multiple samples per pixel.</p>
        </div>
    </section>

    <footer>
        <p style="color: var(--text-color-bright);">19-01-2024</p>
    </footer>
</main>

<!-- Navigation buttons -->
<div style="text-align:center; margin-top:1rem">
    <a href="RayTracing-4.html" class="cta-button">Previous</a>
    <a href="../Blog.html" class="cta-button secondary" style="margin:0 0.75rem">Entries</a>
    <a href="RayTracing-6.html" class="cta-button">Next</a>
</div>

</body>
</html>
