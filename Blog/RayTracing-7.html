<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RayTracing 7</title>
    <link rel="icon" type="image/x-icon" href="../Images/Suprise.webp">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Loris Moreau">
    <meta name="description" content="Raytracing Blog">
    <meta name="keywords" content="Showcase, Loris, Moreau, Loris Moreau, Programmer, coding adventure, Blog, Post, Raytracing, C++, CPP, Raytracing in one weekend, Metal, Reflection, Materials, Shaders">

    <!-- Styles -->
    <link rel="stylesheet" href="../Styles/style.css">
    <link rel="stylesheet" href="../Styles/Code-Quote.css">

    <script src="../Scripts/Carousel.js" defer></script>

</head>

<body>
<!-- Main of the post -->
<main id="BlogPost" class="post">
    <!-- Top showcase: carousel + short intro in a flex row -->
    <header>
        <!-- ========== Section 1 Navbar ========== -->
        <nav style="margin: 0 auto 2em auto;">
            <ul>
                <li><a href="../Blog.html">Back</a></li>
                <li><a href="../index.html" target="_blank">Main</a></li>
                <li><a href="../Blog.html" target="_blank">Blog</a></li>
                <li><a href="../Resources.html" target="_blank">Resources</a></li>
            </ul>
        </nav>

        <!-- Carousel -->
        <div class="flex-container">
            <div class="showcase-carousel" role="region" aria-label="Showcase carousel">
                <button class="carousel-button prev" aria-label="Previous slide">&larr;</button>
                <div class="carousel-viewport">
                    <div class="carousel-track">
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/RayTracing/BasicMaterials.webp" alt="Basic Materials Render">
                        </div>
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/RayTracing/FuzzedMetal.webp" alt="Fuzzed Metal">
                        </div>
                        <div class="carousel-slide">
                            <img loading="lazy" src="../Images/Suprise.webp" alt="Surprise">
                        </div>
                    </div>
                </div>
                <button class="carousel-button next" aria-label="Next slide">&rarr;</button>
                <div class="carousel-dots" aria-hidden="false"></div>
            </div>

            <!-- Intro / author column -->
            <div class="text-container">
                <h1>Raytracing in one weekend in C++ — Part 7</h1>
                <p>Metal reflections, material abstraction and fuzzy metals — adding realistic bounces to your ray tracer.</p>
                <p><a target="_blank" href="https://github.com/Loris-Moreau/RayTracing" class="cta-button">GitHub Repository</a></p>
            </div>
        </div>
    </header>

    <!-- Section: Intro -->
    <section>
        <div>
            <h2 class="underline" style="text-decoration-color: dodgerblue">Metal Reflection</h2>
            <h4>Bounces galore</h4>
            <p style="padding: 5px"></p>
        </div>
        <!-- Section: Material abstraction -->
        
        <h2 class="underline" style="text-decoration-color: royalblue">Material abstraction</h2>

        <p>First we need to classify materials so hittable objects can delegate scattering behavior to them.</p>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Material.h</p></div>
                <div class="Sconsole">
<pre><code>#pragma once

#include "Color.h"
#include "Ray.h"

class HitInfo;

class Material
{
public:
   ~Material() = default;

   virtual bool Scatter(const Ray& rayIn, const HitInfo& hitInfo, Color& attenuation, Ray& scattered) const = 0;
};</code></pre>
                </div>
            </div>
        </div>

        <p style="padding: 5px"></p>
    </section>

    <!-- Section: HitInfo + Sphere material link -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Propagate material through HitInfo</h2>

        <p>Add material reference to HitInfo so the shading code can query scattering.</p>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Hittable.h</p></div>
                <div class="Sconsole">
<pre><code>#pragma once
          
#include "Interval.h"
#include "Material.h"
#include "Ray.h"

class HitInfo
{
public:
   Position coordinates;
   Vector3 normal;
   shared_ptr&ltMaterial> material;
   double time;
   bool frontFace;

   void SetFaceNormal(const Ray& rRay, const Vector3& outwardNormal)
   {
       // NOTE : The outwardNormal vector should be unit length
       frontFace = Dot(rRay.GetDirection(), outwardNormal) &lt 0;
       normal = frontFace ? outwardNormal : -outwardNormal;
   }
};</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Sphere stores material -->
    <section>
        <h2 class="underline" style="text-decoration-color: cadetblue">Spheres with materials</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Sphere.h</p></div>
                <div class="Sconsole">
<pre><code>#pragma once
#include "Hittable.h"

class Sphere: public Hittable
{
private:
   Position mCenter;
   double mRadius;
   shared_ptr&ltMaterial> material;
public:
   Sphere(Position center, double radius, shared_ptr&ltMaterial> mat):mCenter(center), mRadius(radius), material(mat){}
   bool Hit(const Ray& rRay, Interval rayTime, HitInfo& hitInfo) const override;
};</code></pre>
                </div>
            </div>
        </div>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Sphere.cpp</p></div>
                <div class="Sconsole">
<pre><code>bool Sphere::Hit(const Ray& rRay, Interval rayTime, HitInfo& hitInfo) const
{
      ...
      ...
   hitInfo.time = root;
   hitInfo.coordinates = rRay.At(hitInfo.time);
   Vector3 outwardNormal = (hitInfo.coordinates - mCenter) / mRadius;
   hitInfo.SetFaceNormal(rRay, outwardNormal);
   hitInfo.material = material;

   return true;
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Vector utility NearZero -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Vector utility: NearZero</h2>
        <p>Small helper to avoid degenerate scatter directions.</p>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Vector3.h</p></div>
                <div class="Sconsole">
<pre><code>class Vector3
{
...
...
...

   static Vector3 Random(double min, double max)
   {
       return Vector3(RandomDouble(min, max), RandomDouble(min, max), RandomDouble(min, max));
   }

   bool NearZero() const
   {
       double s = 1e-18;
       return fabs(x &lt s) && fabs(y &lt s) && fabs(z &lt s);
   }
};</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Lambertian -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Lambertian material</h2>
        <p>A simple diffuse material that scatters toward the hemisphere.</p>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>LambertianMaterial.h</p></div>
                <div class="Sconsole">
<pre><code>#pragma once

#include "Material.h"

class LambertianMaterial: public Material
{
private:
   Color albedo;

public:
   LambertianMaterial(const Color& baseColor): albedo(baseColor){}

   bool Scatter(const Ray& rayIn, const HitInfo& hitInfo, Color& attenuation, Ray& scattered) const override;
};</code></pre>
                </div>
            </div>
        </div>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>LambertianMaterial.cpp</p></div>
                <div class="Sconsole">
<pre><code>#include "LambertianMaterial.h"

#include "Hittable.h"

bool LambertianMaterial::Scatter(const Ray& rayIn, const HitInfo& hitInfo, Color& attenuation, Ray& scattered) const
{
   Vector3 scatterDirection = hitInfo.normal + RandomUnitVector();

   // Catch invalid directions
   if(scatterDirection.NearZero()) scatterDirection = hitInfo.normal;

   scattered = Ray(hitInfo.coordinates, scatterDirection);
   attenuation = albedo;

   return true;
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Reflect helper -->
    <section>
        <h2 class="underline" style="text-decoration-color: cadetblue">Reflection helper</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Vector3.h</p></div>
                <div class="Sconsole">
<pre><code>inline Vector3 RandomOnHemisphere(const Vector3& normal)
{
   Vector3 onUnitSphere = RandomUnitVector();
   // If in the same hemisphere as the normal
   if(Dot(onUnitSphere, normal) &gt 0.0)
   {
       return onUnitSphere;
   }
   return -onUnitSphere;
}

inline Vector3 Reflect(const Vector3& direction, const Vector3& normal)
{
   return direction - 2 * Dot(direction, normal) * normal;
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Metal material -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Metal material (mirrored)</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>MetalMaterial.h</p></div>
                <div class="Sconsole">
<pre><code>#pragma once

#include "Material.h"

class MetalMaterial:public Material
{
private:
   Color albedo;

public:
   MetalMaterial(const Color& baseColor): albedo(baseColor){}

   bool Scatter(const Ray& rRayIn, const HitInfo& hitInfo, Color& attenuation, Ray& scattered) const override;
};</code></pre>
                </div>
            </div>
        </div>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>MetalMaterial.cpp</p></div>
                <div class="Sconsole">
<pre><code>#include "MetalMaterial.h"

#include "Hittable.h"

bool MetalMaterial::Scatter(const Ray& rRayIn, const HitInfo& hitInfo, Color& attenuation, Ray& scattered) const
{
   Vector3 reflected = Reflect(Unit(rRayIn.GetDirection()), hitInfo.normal);
   scattered = Ray(hitInfo.coordinates, reflected);
   attenuation = albedo;

   return true;
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Integrate into RayColor -->
    <section>
        <h2 class="underline" style="text-decoration-color: cadetblue">Material-based scattering in RayColor</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Camera.cpp</p></div>
                <div class="Sconsole">
<pre><code>Color Camera::RayColor(const Ray& rRay, int bouncesLeft, const Hittable& rWorld) const
{
   HitInfo hitInfo;
  
   if(bouncesLeft &lt= 0) return Color(0, 0, 0);
   if (rWorld.Hit(rRay, Interval(0.001, infinity), hitInfo)) {
       Ray scattered;
       Color attenuation;
       if(hitInfo.material -> Scatter(rRay, hitInfo, attenuation, scattered))
       {
           return attenuation * RayColor(scattered, bouncesLeft - 1, rWorld);
       }
       return Color(0,0,0);
   }

   Vector3 unitDirection = Unit(rRay.GetDirection());
   double blue = 0.5 * (unitDirection.y + 1.0);
   return (1.0 - blue) * Color(1.0, 1.0, 1.0) + blue * Color (0.5, 0.7, 1.0);
}</code></pre>
                </div>
            </div>
        </div>
    </section>

    <!-- Section: Scene setup -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Scene: basic materials</h2>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>Raytracing.cpp</p></div>
                <div class="Sconsole">
<pre><code>int main(int argc, char* argv[])
{
   // World
   HittableCollection world;

   shared_ptr&ltMaterial> groundMat = make_shared&ltLambertianMaterial>(Color(0.8, 0.8, 0.0));
   shared_ptr&ltMaterial> centerMat = make_shared&ltLambertianMaterial>(Color(0.15, 0.15, 0.75));
   shared_ptr&ltMaterial> leftMat = make_shared&ltMetalMaterial>(Color(0.8, 0.8, 0.8));
   shared_ptr&ltMaterial> rightMat = make_shared&ltMetalMaterial>(Color(0.8, 0.6, 0.2));

   world.Add(make_shared&ltSphere>(Position(0,-100.5,-1), 100, groundMat));
   world.Add(make_shared&ltSphere>(Position(0,0,-1), 0.5, centerMat));
   world.Add(make_shared&ltSphere>(Position(-1.0,0,-1), 0.5, leftMat));
   world.Add(make_shared&ltSphere>(Position(1.0,0,-1), 0.5, rightMat));

  
   Camera camera(400, 16.0/9.0, 100, 50);
   camera.Render(world);
   return 0;
}</code></pre>
                </div>
            </div>
        </div>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/BasicMaterials.webp" alt="Render with Basic Materials" style="width:40%; padding-bottom:5px" />
            <figcaption><a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html#metal/ascenewithmetalspheres" target="_blank">img. Source</a></figcaption>
        </figure>
    </section>

    <!-- Section: Fuzziness -->
    <section>
        <h2 class="underline" style="text-decoration-color: royalblue">Fuzziness (fuzzy metals)</h2>

        <p>Introduce a fuzz factor to randomize the reflection direction within a small sphere around the perfect reflection.</p>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>MetalMaterial.h</p></div>
                <div class="Sconsole">
<pre><code>#pragma once

#include "Material.h"

class MetalMaterial:public Material
{
private:
   Color albedo;
   double fuzz;  //Here

public:
   MetalMaterial(const Color& baseColor, double f): albedo(baseColor), fuzz(f&lt1? f : 1){}  //Here too

   bool Scatter(const Ray& rRayIn, const HitInfo& hitInfo, Color& attenuation, Ray& scattered) const override;
};</code></pre>
                </div>
            </div>
        </div>

        <div class="snippet">
            <div class="Swindow">
                <div class="Swindow-title"><p>MetalMaterial.cpp</p></div>
                <div class="Sconsole">
<pre><code>#include "MetalMaterial.h"
#include "Hittable.h"

bool MetalMaterial::Scatter(const Ray& rRayIn, const HitInfo& hitInfo, Color& attenuation, Ray& scattered) const
{
   Vector3 reflected = Reflect(Unit(rRayIn.GetDirection()), hitInfo.normal);
   scattered = Ray(hitInfo.coordinates, reflected + fuzz * RandomUnitVector());
   attenuation = albedo;

   return Dot(scattered.GetDirection(), hitInfo.normal) &gt 0;
}</code></pre>
                </div>
            </div>
        </div>

        <figure>
            <img loading="lazy" src="../Images/RayTracing/FuzzedMetal.webp" alt="Fuzzy Metal" style="width:40%; padding-bottom:5px" />
            <figcaption><a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html#metal/fuzzyreflection" target="_blank">img. Source</a></figcaption>
        </figure>
    </section>

    <footer>
        <p style="color: var(--text-color-bright);">21-01-2024</p>
    </footer>
</main>

<!-- Navigation buttons -->
<div style="text-align:center; margin-top:1rem">
    <a href="RayTracing-6.html" class="cta-button">Previous</a>
    <a href="../Blog.html" class="cta-button secondary" style="margin:0 0.75rem">Entries</a>
    <a href="RayTracing-8.html" class="cta-button">Next</a>
</div>

</body>
</html>
